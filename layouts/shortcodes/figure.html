<figure>
  {{- $u := urls.Parse (.Get "src") -}}
  {{- $src := $u.String -}}
  {{- if not $u.IsAbs -}}
    {{- with or (.Page.Resources.Get $u.Path) (resources.Get $u.Path) -}}
      {{- $src = .RelPermalink -}}
    {{- end -}}
  {{- end -}}

  {{ $caption := $.Get "caption" | markdownify | plainify }}

  <img src="{{ $src }}" alt="{{ $caption }}" />

  {{ if $caption }}
    <figcaption>
      <p>{{ $caption }}</p>
    </figcaption>
  {{ end }}
</figure>